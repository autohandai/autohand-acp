name: Submit to Zed Registry

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to submit (e.g., 0.1.3) - leave empty to use latest'
        required: false

permissions:
  contents: read

jobs:
  submit-to-zed:
    name: Submit to Zed Extension Registry
    runs-on: ubuntu-latest
    steps:
      - name: Checkout autohand-acp
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Get latest tag
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            VERSION="${VERSION#v}"
          fi

          if [ -z "$VERSION" ]; then
            echo "Error: No version specified and no tags found"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Verify release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          echo "Checking release artifacts for v$VERSION..."

          # Use gh CLI which has authentication for private repos
          ASSETS=$(gh release view "v$VERSION" --json assets --jq '.assets[].name' 2>/dev/null || echo "")

          if [ -z "$ASSETS" ]; then
            echo "✗ Release v$VERSION not found"
            exit 1
          fi

          REQUIRED_ASSETS="autohand-acp-darwin-arm64.tar.gz autohand-acp-darwin-x64.tar.gz autohand-acp-linux-x64.tar.gz autohand-acp-windows-x64.zip"

          for asset in $REQUIRED_ASSETS; do
            if echo "$ASSETS" | grep -q "^$asset$"; then
              echo "✓ $asset available"
            else
              echo "✗ Missing: $asset"
              exit 1
            fi
          done

          echo ""
          echo "All release artifacts verified!"

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create PR to Zed Registry
        env:
          GH_TOKEN: ${{ secrets.ZED_REGISTRY_PAT }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${{ github.repository }}"

          if [ -z "$GH_TOKEN" ]; then
            echo "================================================"
            echo "MANUAL STEP REQUIRED"
            echo "================================================"
            echo ""
            echo "No ZED_REGISTRY_PAT secret found."
            echo "To automate this, add a GitHub PAT with 'repo' scope as ZED_REGISTRY_PAT secret."
            echo ""
            echo "Manual submission steps:"
            echo ""
            echo "1. Fork https://github.com/zed-industries/extensions"
            echo ""
            echo "2. Clone your fork:"
            echo "   git clone https://github.com/YOUR_USERNAME/extensions.git"
            echo "   cd extensions"
            echo ""
            echo "3. Add the extension as a submodule:"
            echo "   git submodule add https://github.com/$REPO.git extensions/autohand-acp"
            echo ""
            echo "4. Add to extensions.toml:"
            echo "   [autohand-acp]"
            echo "   submodule = \"extensions/autohand-acp\""
            echo "   version = \"$VERSION\""
            echo ""
            echo "5. Sort and commit:"
            echo "   pnpm sort-extensions"
            echo "   git add ."
            echo "   git commit -m \"Add autohand-acp extension v$VERSION\""
            echo "   git push origin main"
            echo ""
            echo "6. Create PR: https://github.com/zed-industries/extensions/compare"
            echo ""
            echo "================================================"
            exit 0
          fi

          echo "ZED_REGISTRY_PAT found, creating PR automatically..."

          # Configure git to use the PAT for authentication
          git config --global url."https://${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

          # Fork the repo (if not already forked)
          gh repo fork zed-industries/extensions --clone=false || true

          # Get the fork name
          FORK_OWNER=$(gh api user --jq '.login')
          echo "Fork owner: $FORK_OWNER"

          # Clone the fork using gh (which handles auth)
          gh repo clone "$FORK_OWNER/extensions" zed-extensions -- --depth=1
          cd zed-extensions

          # Set up remotes with auth
          git remote set-url origin "https://${GH_TOKEN}@github.com/$FORK_OWNER/extensions.git"
          git remote add upstream https://github.com/zed-industries/extensions.git 2>/dev/null || true
          git fetch upstream
          git checkout main
          git reset --hard upstream/main

          # Create a branch for the PR
          BRANCH="add-autohand-acp-v$VERSION"
          git checkout -b "$BRANCH"

          # Check if extension already exists
          if [ -d "extensions/autohand-acp" ]; then
            echo "Extension already exists, updating..."
            cd extensions/autohand-acp
            git fetch origin
            git checkout "v$VERSION" || git checkout main
            cd ../..
          else
            echo "Adding new extension..."
            git submodule add "https://github.com/$REPO.git" extensions/autohand-acp
            cd extensions/autohand-acp
            git checkout "v$VERSION" || git checkout main
            cd ../..
          fi

          # Update extensions.toml
          if grep -q "\[autohand-acp\]" extensions.toml; then
            # Update existing entry
            sed -i "/\[autohand-acp\]/,/^$/s/version = .*/version = \"$VERSION\"/" extensions.toml
          else
            # Add new entry (will be sorted later)
            cat >> extensions.toml << EOF

          [autohand-acp]
          submodule = "extensions/autohand-acp"
          version = "$VERSION"
          EOF
          fi

          # Sort extensions (if pnpm available)
          if command -v pnpm &> /dev/null; then
            pnpm install
            pnpm sort-extensions
          fi

          # Commit changes
          git add .
          git commit -m "Add autohand-acp extension v$VERSION"

          # Push to fork
          git push -u origin "$BRANCH" --force

          # Create PR
          PR_BODY=$(cat << 'PREOF'
          ## Extension: Autohand CLI

          AI coding agent powered by Autohand CLI via Agent Client Protocol (ACP).

          ### Features
          - File editing and code modifications
          - Code search across codebase
          - Terminal command execution
          - Session management and history
          - Permission controls (external/auto/restricted)
          - Dynamic session titles
          - Image/screenshot support
          - MCP server integration

          ### Links
          - Repository: https://github.com/${{ github.repository }}
          - Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}
          PREOF
          )

          gh pr create \
            --repo zed-industries/extensions \
            --title "Add autohand-acp extension v$VERSION" \
            --body "$PR_BODY" \
            --head "$FORK_OWNER:$BRANCH" \
            --base main

          echo ""
          echo "================================================"
          echo "PR created successfully!"
          echo "================================================"
